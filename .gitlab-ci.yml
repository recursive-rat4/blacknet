#!/bin/false
#
# Copyright (c) 2020-2024 Pavel Vasin
#
# Licensed under the Jelurida Public License version 1.1
# for the Blacknet Public Blockchain Platform (the "License");
# you may not use this file except in compliance with the License.
# See the LICENSE.txt file at the top-level directory of this distribution.
#

.openjdk:
  image: maven:3.9.9-eclipse-temurin-21@sha256:5a44dff9390bff393693518d70233977ff245c2876320655a47be5622719becf
  variables:
    MAVEN: "mvn --batch-mode --no-transfer-progress" #TODO 4
    MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository"
  cache:
    paths:
      - .m2/repository

stages:
  - scan
  - test
  - build

openjdk-scan:
  extends: .openjdk
  stage: scan
  script:
    - $MAVEN artifact:check-buildplan cyclonedx:makeAggregateBom
  rules:
    - changes:
      - pom.xml
      - "**/pom.xml"
      when: on_success
    - when: never
  artifacts:
    reports:
      cyclonedx: target/bom.json

openjdk-test:
  extends: .openjdk
  stage: test
  script:
    - $MAVEN test
  rules:
    - changes:
      - pom.xml
      - "**/pom.xml"
      - "**/*.java"
      - "**/*.kt"
      when: on_success
    - when: never
  artifacts:
    reports:
      junit:
        - "**/target/surefire-reports/TEST-*.xml"

openjdk-build:
  extends: .openjdk
  stage: build
  variables:
    DESTDIR: "blacknet-$CI_COMMIT_TAG"
  script:
    - $MAVEN verify
    - mkdir -p $DESTDIR
    - cp -a daemon/target/appassembler/* $DESTDIR
  rules:
    - if: $CI_COMMIT_TAG
      when: on_success
    - when: never
  artifacts:
    name: blacknet-gitlab-build
    paths:
      - $DESTDIR
