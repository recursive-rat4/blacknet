#!/bin/false
#
# Copyright (c) 2020-2024 Pavel Vasin
#
# Licensed under the Jelurida Public License version 1.1
# for the Blacknet Public Blockchain Platform (the "License");
# you may not use this file except in compliance with the License.
# See the LICENSE.txt file at the top-level directory of this distribution.
#

image: maven:3.9.6-eclipse-temurin-21@sha256:9d65a155951f0c6481a89b9d7c6e2eafe45843c0c47b71a997bfc7206c822800

variables:
  MAVEN: "mvn --batch-mode --no-transfer-progress" #TODO 4
  MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository"

cache:
  paths:
    - .m2/repository

stages:
  - cyclonedx
  - test
  - build

cyclonedx:
  stage: cyclonedx
  script:
    - $MAVEN cyclonedx:makeAggregateBom
  rules:
    - changes:
      - pom.xml
      when: on_success
    - when: never
  artifacts:
    reports:
      cyclonedx: target/bom.json

test:
  stage: test
  script:
    - $MAVEN test
  artifacts:
    reports:
      junit:
        - "**/target/surefire-reports/TEST-*.xml"

build:
  stage: build
  variables:
    DESTDIR: "blacknet-$CI_COMMIT_TAG"
  script:
    - $MAVEN verify
    - mkdir -p $DESTDIR
    - cp -a daemon/target/appassembler/* $DESTDIR
  rules:
    - if: $CI_COMMIT_TAG
      when: on_success
    - when: never
  artifacts:
    name: blacknet-gitlab-build
    paths:
      - $DESTDIR
