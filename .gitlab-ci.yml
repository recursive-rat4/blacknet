#!/bin/false
#
# Copyright (c) 2020-2024 Pavel Vasin
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Lesser General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU Lesser General Public License for more details.
#
# You should have received a copy of the GNU Lesser General Public License
# along with this program. If not, see <https://www.gnu.org/licenses/>.
#

.gcc:
  image: gcc:14.2.0@sha256:561e2a4b76c441215d26625fbf2d5e345da60ef22b7d46e6ab45d1d53d95c43e

.openjdk:
  image: maven:3.9.9-eclipse-temurin-21@sha256:5a44dff9390bff393693518d70233977ff245c2876320655a47be5622719becf
  variables:
    MAVEN: "mvn --batch-mode --no-transfer-progress" #TODO 4
    MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository"
  cache:
    paths:
      - .m2/repository

stages:
  - scan
  - test
  - build

gcc-test:
  extends: .gcc
  stage: test
  before_script:
    - apt-get update && apt-get -y install libboost-dev libboost-random-dev libboost-test-dev
  script:
    - cd crypto/src/main/cplusplus
    - make ci-test
  rules:
    - changes:
      - "**/Makefile"
      - "**/*.h"
      - "**/*.cpp"
      when: on_success
    - when: never
  artifacts:
    reports:
      junit:
        - "crypto/src/main/cplusplus/TEST.xml"

openjdk-scan:
  extends: .openjdk
  stage: scan
  script:
    - $MAVEN artifact:check-buildplan cyclonedx:makeAggregateBom
  rules:
    - changes:
      - pom.xml
      - "**/pom.xml"
      when: on_success
    - when: never
  artifacts:
    reports:
      cyclonedx: target/bom.json

openjdk-test:
  extends: .openjdk
  stage: test
  script:
    - $MAVEN test
  rules:
    - changes:
      - pom.xml
      - "**/pom.xml"
      - "**/*.java"
      - "**/*.kt"
      when: on_success
    - when: never
  artifacts:
    reports:
      junit:
        - "**/target/surefire-reports/TEST-*.xml"

openjdk-build:
  extends: .openjdk
  stage: build
  variables:
    DESTDIR: "blacknet-$CI_COMMIT_TAG"
  script:
    - $MAVEN verify
    - mkdir -p $DESTDIR
    - cp -a daemon/target/appassembler/* $DESTDIR
  rules:
    - if: $CI_COMMIT_TAG
      when: on_success
    - when: never
  artifacts:
    name: blacknet-gitlab-build
    paths:
      - $DESTDIR
