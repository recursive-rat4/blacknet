#!/bin/false
#
# Copyright (c) 2020 Pavel Vasin
#
# Licensed under the Jelurida Public License version 1.1
# for the Blacknet Public Blockchain Platform (the "License");
# you may not use this file except in compliance with the License.
# See the LICENSE.txt file at the top-level directory of this distribution.
#

image: eclipse-temurin:19.0.2_7-jdk@sha256:81b8481b570155419ec2b057f4a367d6f0f22a5700aa01b7de7ceaa731519b1f

variables:
  GRADLE_USER_HOME: ".gradle"

cache:
  paths:
    - .gradle/wrapper
    - .gradle/caches

stages:
#FIXME report is empty
#TODO how to properly upload report for gitlab ui?
#  - license_scanning
  - test
  - build

#license_scanning:
#  stage: license_scanning
#  script:
#    - ./gradlew downloadLicenses
#  rules:
#    - changes:
#      - 3RD-PARTY-LICENSES.txt
#      - LICENSE.txt
#      - gradle/libs.versions.toml
#      - gradle/verification-metadata.xml
#      - gradle/wrapper/gradle-wrapper.properties
#      when: on_success
#    - when: never
#  artifacts:
#    reports:
#      license_scanning: gl-license-scanning-report.json

test:
  stage: test
  script:
    - rm ./gradle/verification-metadata.xml #FIXME
    - ./gradlew test
  artifacts:
    reports:
      junit:
        - json-rpc/build/test-results/test/TEST-*.xml
        - kernel/build/test-results/test/TEST-*.xml
        - runtime/build/test-results/test/TEST-*.xml
        - serialization/build/test-results/test/TEST-*.xml
        - time/build/test-results/test/TEST-*.xml

build:
  stage: build
  script:
    - ./gradlew distTar
    - tar -xf build/distributions/blacknet-*.*.*.tar
  rules:
    - if: $CI_COMMIT_TAG
      when: on_success
    - when: never
  artifacts:
    name: blacknet-gitlab-build
    paths:
      - blacknet-*.*.*
