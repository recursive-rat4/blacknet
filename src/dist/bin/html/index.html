<!--
  ~ Copyright (c) 2018 Pavel Vasin
  ~
  ~ Licensed under the Jelurida Public License version 1.1
  ~ for the Blacknet Public Blockchain Platform (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ See the LICENSE.txt file at the top-level directory of this distribution.
  -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Blacknet</title>
    <style>
        * {
          margin: 0;
          padding: 0;
          font-family: sans-serif;
        }

        :root {
          --darker-grey-bg: #2D2D2D;
          --lighter-grey-bg: #3B3B3B;
          --gold-text: #E8BA3F;
          --grey-text: #ADADAD;
        }

        body {
          background-color:var(--lighter-grey-bg);
        }

        header, footer {
          color: var(--gold-text);
          background-color: var(--darker-grey-bg);
          padding: 1rem;
        }

        .container {
          width: 80%;
          margin: 0 auto;
          padding: 1rem 0;
        }

        p {
          padding: 2px;
        }

        fieldset {
          padding: 1rem;
          border: 1px groove;
          border-color: var(--darker-grey-bg);
          margin: 1rem 0;
        }

        legend {
          color: var(--grey-text);
          font-size: 1.5em;
          font-weight: bold;
          padding-left: 4px;
          padding-right: 4px;
        }

        label {
          color: var(--grey-text);
          flex-basis: 123px;
          flex-grow: 1;
        }

        input {
          border: 2px solid var(--darker-grey-bg);
          border-radius: 4px;
          height: 1.5em;
          width: 80%;
          padding: .25rem;
          background-color: var(--grey-text);
          flex-grow: 8;
        }
        input:read-only {
          background-color: var(--lighter-grey-bg);
          color: var(--gold-text);
          border: none;
          font-size: 1.15em;
        }
        input:-moz-read-only {
          background-color: var(--lighter-grey-bg);
          color: var(--gold-text);
          border: none;
          font-size: 1.15em;
        }
        input:focus {
          box-shadow: inset 0 0 4px #000000;
        }

        button {
          font-size: 1.25em;
          cursor: pointer;
          border-radius: 4px;
          border: 2px solid var(--darker-grey-bg);
          padding: .25rem;
        }

        .field-row {
          display: flex;
          align-items: center;
          margin-bottom: 1rem;
        }

        #node-table, #block-table {
          table-layout: fixed;
          width: 100%;
        }

        caption {
          color: var(--grey-text);
          padding: .5rem;
          background-color: var(--darker-grey-bg);
        }

        thead td {
          color: var(--grey-text);
          padding: .5rem;
        }

        tbody td {
          color: var(--grey-text);
          padding: .25rem .5rem;
          word-wrap: break-word;
        }

        td.narrow {
          width: 70px;
        }

        tr:hover {
          background-color: var(--darker-grey-bg);
        }

        #api-menu {
          display: flex;
          justify-content: space-between;
          list-style: none;
          height: 35px;
          align-items: center;
        }

        .menu-item {
          padding-left: 5px;
          padding-right: 5px;
          cursor: pointer;
        }
    </style>
</head>
<body>

<header>
<h1>Blacknet</h1>
<p id="info_height"></p>
<p id="info_connections"></p>
</header>

<div class="container">

<div>
  <fieldset>
    <legend>Start staking</legend>
    <div class="field-row">
    <label>Mnemonic</label>
    <input type="password" id="start_staking_mnemonic">
    </div>
    <div class="field-row">
    <label>Result</label>
    <input type="text" id="start_staking_result" readonly>
    </div>
    <button onclick="start_staking();">Start staking</button>
  </fieldset>

  <fieldset>
    <legend>Get balance</legend>
    <div class="field-row">
    <label>Account</label>
    <input type="text" id="balance_account">
    </div>
    <div class="field-row">
    <label>Result</label>
    <input type="text" id="balance_result" readonly>
    </div>
    <button onclick="balance();">Get balance</button>
  </fieldset>

  <fieldset>
    <legend>Transfer</legend>
    <div class="field-row">
    <label>Mnemonic</label>
    <input type="password" id="transfer_mnemonic">
    </div>
    <div class="field-row">
    <label>Fee</label>
    <input type="text" id="transfer_fee">
    </div>
    <div class="field-row">
    <label>Amount</label>
    <input type="text" id="transfer_amount">
    </div>
    <div class="field-row">
    <label>To</label>
    <input type="text" id="transfer_to">
    </div>
    <div class="field-row">
    <label>Message</label>
    <input type="text" id="transfer_message">
    </div>
    <div class="field-row">
    <label>Encrypted</label>
    <input type="checkbox" id="transfer_encrypted">
    </div>
    <div class="field-row">
    <label>Result</label>
    <input type="text" id="transfer_result" readonly>
    </div>
    <button onclick="transfer();">Transfer</button>
  </fieldset>

  <fieldset>
    <legend>Sign message</legend>
    <div class="field-row">
    <label>Mnemonic</label>
    <input type="password" id="sign_mnemonic">
    </div>
    <div class="field-row">
    <label>Message</label>
    <input type="text" id="sign_message">
    </div>
    <div class="field-row">
    <label>Result</label>
    <input type="text" id="sign_result" readonly>
    </div>
    <button onclick="sign();">Sign message</button>
  </fieldset>

  <fieldset>
    <legend>Verify message</legend>
    <div class="field-row">
    <label>Account</label>
    <input type="text" id="verify_account">
    </div>
    <div class="field-row">
    <label>Signature</label>
    <input type="text" id="verify_signature">
    </div>
    <div class="field-row">
    <label>Message</label>
    <input type="text" id="verify_message">
    </div>
    <div class="field-row">
    <label>Result</label>
    <input type="text" id="verify_result" readonly>
    </div>
    <button onclick="verify();">Verify message</button>
  </fieldset>

  <fieldset>
    <legend>Mnemonic info</legend>
    <div class="field-row">
    <label>Mnemonic</label>
    <input type="password" id="mnemonic_info">
    </div>
    <div class="field-row">
    <label>Result</label>
    <input type="text" id="mnemonic_info_result" readonly>
    </div>
    <button onclick="mnemonic_info();">Mnemonic info</button>
  </fieldset>
</div>

<div>
  <table id="node-table">
  <caption>Connected Nodes</caption>
  <thead>
  <tr><td>IP</td><td class="narrow">Ping</td><td>Bytes Read</td><td>Bytes Written</td><td class="narrow">In/Out</td></tr>
  </thead>
  <tbody id="node-list">
  </tbody>
  </table>
  <!-- <template> is poplulated by display_node_list() -->
  <template id="node-row">
  <tr>
    <td></td>
    <td class="narrow"></td>
    <td></td>
    <td></td>
    <td class="narrow"></td>
  </tr>
  </template>
</div>

<div>
  <table id="block-table">
  <caption>Recent Blocks</caption>
  <thead>
  <tr><td class="narrow">Height</td><td>Hash</td><td class="narrow">Size</td><td class="narrow">Time</td><td class="narrow">Txns</td><td>Generator</td></tr>
  </thead>
  <tbody id="block-list">
  </tbody>
  </table>
  <!-- <template> is poplulated by display_block_list() -->
  <template id="block-row">
  <tr>
    <td class="narrow"></td>
    <td></td>
    <td class="narrow"></td>
    <td class="narrow"></td>
    <td class="narrow"></td>
    <td></td>
  </tr>
  </template>
</div>

</div> <!-- End container div -->

<footer>
<ul id="api-menu">
  <li onclick="display_api_json_result('peerinfo');" class="menu-item">peerinfo</li>
  <li onclick="display_api_json_result('nodeinfo');" class="menu-item">nodeinfo</li>
  <li onclick="display_api_json_result('ledger');" class="menu-item">ledger</li>
  <li onclick="display_api_json_result('peerdb');" class="menu-item">peerdb</li>
</ul>
<pre id='api-json-result'></pre>
</footer>

<script type="text/javascript">
function request_promise(method, url) {
  return new Promise( function(resolve, reject) {
    url = "/api/v1" + url;
    const xhr = new XMLHttpRequest();
    xhr.open(method, url, true);
    xhr.onload = function() {
      if (this.status >= 200 && this.status < 300) {
        resolve(xhr.responseText);
      } else {
        reject({
          status: this.status,
          statusText: xhr.statusText
        });
      }
    };
    xhr.onerror = function () {
      reject({
        status: this.status,
        statusText: xhr.statusText
      });
    };
    xhr.send();
  });
}
function request(method, url, callback) {
    url = "/api/v1" + url
    let xhr = new XMLHttpRequest();
    xhr.addEventListener('load', callback);
    xhr.open(method, url, true);
    xhr.send();
}
function start_staking() {
    let mnemonic = document.getElementById('start_staking_mnemonic').value;
    let url = "/staker/start/" + mnemonic + "/";

    request("POST", url, function () {
        document.getElementById('start_staking_result').value = this.responseText;
    });

    url = "/mnemonic/info/" + mnemonic + "/";
    request("POST", url, function () {
        const data = JSON.parse(this.responseText);
        data.mnemonic = '[hidden]';
        document.getElementById('mnemonic_info_result').value = JSON.stringify(data);
        document.getElementById('balance_account').value = data.address;
        balance();
    });
}
function balance() {
    let account = document.getElementById('balance_account').value;
    let url = "/ledger/get/" + account + "/";

    request("GET", url, function () {
        if (this.status == 404) {
            document.getElementById('balance_result').value = 0;
            return;
        }
        let data = JSON.parse(this.responseText)
        document.getElementById('balance_result').value = data.balance;
    });
}
function transfer() {
    let mnemonic = document.getElementById('transfer_mnemonic').value;
    let fee = document.getElementById('transfer_fee').value;
    let amount = document.getElementById('transfer_amount').value;
    let to = document.getElementById('transfer_to').value;
    let message = document.getElementById('transfer_message').value;
    let encrypted = message && document.getElementById('transfer_encrypted').checked ? "1" : "";
    let url = "/transfer/" + mnemonic + "/" + fee + "/" + amount + "/" + to + "/" + message + "/" + encrypted + "/";

    request("POST", url, function () {
        document.getElementById('transfer_result').value = this.responseText;
    });
}
function sign() {
    let mnemonic = document.getElementById('sign_mnemonic').value;
    let message = document.getElementById('sign_message').value;
    let url = "/signmessage/" + mnemonic + "/" + message + "/";

    request("POST", url, function () {
        document.getElementById('sign_result').value = this.responseText;
    });
}
function verify() {
    let account = document.getElementById('verify_account').value;
    let signature = document.getElementById('verify_signature').value;
    let message = document.getElementById('verify_message').value;
    let url = "/verifymessage/" + account + "/" + signature + "/" + message + "/";

    request("GET", url, function () {
        document.getElementById('verify_result').value = this.responseText;
    });
}
function mnemonic_info() {
    let mnemonic = document.getElementById('mnemonic_info').value;
    let url = "/mnemonic/info/" + mnemonic + "/";

    request("POST", url, function () {
        document.getElementById('mnemonic_info_result').value = this.responseText;
    });
}
async function display_api_json_result(apiCall) {
  if (apiCall === '') return;
  const url = `/${apiCall}/`;
  const textData = await request_promise("GET", url);
  const jsonData = JSON.parse(textData);
  const pre = document.getElementById("api-json-result");
  const h2 = document.createElement('h2');
  const p = document.createElement('p');
  pre.innerHTML = '';
  h2.innerHTML = apiCall;
  p.innerHTML = '[Close]';
  p.style.cursor = 'pointer';
  p.onclick = function(){ pre.innerHTML = '' };
  pre.append(h2);
  pre.append(p);
  pre.append(textData);
  switch (apiCall) {
    case "nodeinfo":
      document.getElementById('info_connections').innerHTML = "Connections: " + jsonData.outgoing + " outgoing, " + jsonData.incoming + " incoming";
      break;
    case "ledger":
      document.getElementById('info_height').innerHTML = "Blockchain height: " + jsonData.height;
      break;
    case "peerinfo":
      display_node_list(jsonData);
      break;
  }
}
function display_node_list(data) {
  const tbody = document.querySelector('#node-list');
  const template = document.querySelector('#node-row');
  tbody.innerHTML = '';
  data.forEach( (node) => {
    const clone = document.importNode(template.content, true);
    const td = clone.querySelectorAll('td');
    td[0].textContent = node.remoteAddress;
    td[1].textContent = node.ping;
    td[2].textContent = node.totalBytesRead;
    td[3].textContent = node.totalBytesWritten;
    td[4].textContent = node.state === 'INCOMING_CONNECTED' ? 'In'  : 'Out';
    tbody.appendChild(clone);
  });
}
async function add_block(hash, height) {
  const url = `/blockdb/get/${hash}`;
  let blockData = await request_promise('GET', url);
  blockData = JSON.parse(blockData);
  const table = document.getElementById("block-table");
  const rowCount = table.rows.length;
  rowCount > 10 ? table.deleteRow(rowCount-1) : false ;
  const tbody = document.querySelector('#block-list');
  const template = document.querySelector('#block-row');
  const clone = document.importNode(template.content, true);
  const td = clone.querySelectorAll('td');
  td[0].textContent = height;
  td[1].textContent = hash;
  td[2].textContent = blockData.size;
  td[3].textContent = unix_to_local_time(blockData.time);
  td[4].textContent = blockData.transactions.length;
  td[5].textContent = blockData.generator;
  tbody.prepend(clone);
}
function unix_to_local_time(unix_timestamp) {
  const date = new Date(unix_timestamp*1000);
  const hours = date.getHours();
  const minutes = "0" + date.getMinutes();
  const seconds = "0" + date.getSeconds();
  return hours + ':' + minutes.substr(-2) + ':' + seconds.substr(-2);
}
async function request_info(message={}) {
  let ledgerData = await request_promise("GET", "/ledger");
  ledgerData = JSON.parse(ledgerData);
  document.getElementById('info_height').innerHTML = "Blockchain height: " + ledgerData.height;

  let nodeInfoData = await request_promise("GET", "/nodeinfo");
  nodeInfoData = JSON.parse(nodeInfoData);
  document.getElementById('info_connections').innerHTML = "Connections: " + nodeInfoData.outgoing + " outgoing, " + nodeInfoData.incoming + " incoming";

  let peerInfoData = await request_promise("GET", "/peerinfo");
  peerInfoData = JSON.parse(peerInfoData);
  display_node_list(peerInfoData);

  if ( message.data ) { add_block(message.data, ledgerData.height); }
}
request_info();
let ws = new WebSocket("ws://localhost:8283/api/v1/notify/block");
ws.onmessage = request_info;
</script>
</body>
</html>
